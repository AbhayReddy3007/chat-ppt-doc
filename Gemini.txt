from docx import Document
from docx.shared import Pt, Inches
from docx.enum.text import WD_ALIGN_PARAGRAPH
import re


def clean_title_text(title: str) -> str:
    if not title:
        return "Document"
    title = re.sub(r"\s+", " ", title.strip())
    return title


def create_doc(title, sections, filename="output.docx", images=None):
    doc = Document()

    # --- Title Page ---
    doc.add_heading(clean_title_text(title), 0)

    # --- Content Sections ---
    for idx, item in enumerate(sections, start=1):
        section_title = clean_title_text(item.get("title", ""))
        description = item.get("description", "")

        # Section Title
        doc.add_heading(section_title, level=1)

        # Paragraphs
        for para in description.split("\n"):
            if para.strip():
                p = doc.add_paragraph(para.strip())
                p.style.font.size = Pt(12)
                p.alignment = WD_ALIGN_PARAGRAPH.JUSTIFY

        # Insert image if available
        if images and idx-1 < len(images) and images[idx-1]:
            try:
                img_path = images[idx-1]
                doc.add_picture(img_path, width=Inches(4.5))
                last_paragraph = doc.paragraphs[-1]
                last_paragraph.alignment = WD_ALIGN_PARAGRAPH.CENTER
            except Exception as e:
                print(f"⚠️ Could not add image to section {idx}: {e}")

    doc.save(filename)
    return filename
